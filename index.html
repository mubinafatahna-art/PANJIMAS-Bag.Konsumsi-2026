<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>Monitoring Konsumsi</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light p-4">
    <div class="container">
        <h2 class="text-center mb-4">DASHBOARD KONSUMSI</h2>
        
        <div class="row mb-4 text-white">
            <div class="col-md-4"><div class="card bg-primary p-3">Total: <h3 id="at">Rp 0</h3></div></div>
            <div class="col-md-4"><div class="card bg-danger p-3">Terpakai: <h3 id="dt">Rp 0</h3></div></div>
            <div class="col-md-4"><div class="card bg-success p-3">Sisa: <h3 id="sa">Rp 0</h3></div></div>
        </div>

        <div class="row">
            <div class="col-md-4">
                <form id="f">
                    <input type="text" id="n1" class="form-control mb-2" placeholder="No Pesanan" required>
                    <input type="date" id="n2" class="form-control mb-2" required>
                    <select id="n3" class="form-control mb-2"><option>Fatahna</option><option>Anggota 2</option></select>
                    <input type="text" id="n4" class="form-control mb-2" placeholder="Item/Menu" required>
                    <input type="number" id="n5" class="form-control mb-2" placeholder="Nominal" required>
                    <input type="file" id="n6" class="form-control mb-2" accept="image/*" required>
                    <button type="submit" id="btn" class="btn btn-primary w-100">Upload Data</button>
                </form>
            </div>
            <div class="col-md-8">
                <table class="table bg-white shadow-sm">
                    <thead><tr><th>No</th><th>Nama</th><th>Nominal</th><th>Nota</th></tr></thead>
                    <tbody id="tb"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzEUHWy-1z5q1p3LWuAL4bOXP_1WQ1DbzmSRiiHznVjGrN48Ngzdm9BPhhcjiKLAhRN/exec";
        const BUDGET_AWAL = 180000000;

        // Ambil Data
        function load() {
            fetch(SCRIPT_URL).then(r => r.json()).then(d => {
                let h = "", total = 0;
                for(let i=1; i<d.length; i++) {
                    total += Number(d[i][5]);
                    h += `<tr><td>${d[i][1]}</td><td>${d[i][3]}</td><td>${Number(d[i][5]).toLocaleString()}</td><td><a href="${d[i][6]}" target="_blank">Lihat</a></td></tr>`;
                }
                document.getElementById('tb').innerHTML = h;
                document.getElementById('at').innerText = "Rp " + BUDGET_AWAL.toLocaleString();
                document.getElementById('dt').innerText = "Rp " + total.toLocaleString();
                document.getElementById('sa').innerText = "Rp " + (BUDGET_AWAL - total).toLocaleString();
            });
        }

        // Kirim Data
        document.getElementById('f').onsubmit = function(e) {
            e.preventDefault();
            document.getElementById('btn').innerText = "Proses...";
            const fr = new FileReader();
            fr.readAsDataURL(document.getElementById('n6').files[0]);
            fr.onload = () => {
                const body = {
                    noPesanan: document.getElementById('n1').value,
                    tglPesan: document.getElementById('n2').value,
                    nama: document.getElementById('n3').value,
                    keperluan: document.getElementById('n4').value,
                    nominal: document.getElementById('n5').value,
                    imageBlob: fr.result
                };
                fetch(SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(body) })
                .then(() => { alert('Sukses!'); location.reload(); });
            };
        };
        load();
    </script>
</body>
</html>
